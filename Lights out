// Deze code is gemaakt door Koen van der Mije(s4809033) en Dylan Kusters (s4912926).
//Opdracht 3 van programmeermethoden: Lights out.

#include <iostream>
#include <fstream>
#include <climits>


using namespace std;

class Puzzel {
public:
    static const int MaxGrootte = 20; //max hoogte en breedte van de puzzel
    

    int hoogte; //hoogte van de puzzel
    int breedte; //breedte van de puzzel
    double percentage; //percentage lampen aan in de puzzel
    char symboolLampAan; //het symbool in de puzzel als de lamp aan staat
    char symboolLampUit; //het symbool in de puzzel als de lamp uit staat
    char cursorSymbool; //het symbool in de puzzel waar de cursor is
    bool torusMode; //of de torusMode aan staat of niet
    int randomNum; //een getal die random gegenereerd wordt
    int cursorKolom; //in welke kolom de cursor zich bevindt
    int cursorRij; //in welke rij de cursor zich bevindt
    int dePuzzel[MaxGrootte][MaxGrootte]; //de puzzel zelf
    int oplossing[100][2]; //een array waarin de oplossing bewaard wordt -
    //  met coordinaat en de hoeveelste zet
    int aantalZetten; //het totaal aantal zetten door de gebruiker

    Puzzel(int h = 5, int b = 5, double p = 50.0, char a = 'X', char u = '.',
         char c = ' ', bool t = false, int k = 1, int r = 1);
    int randomgetal();
    void maakschoon();
    void maakrandom();
    void drukaf(bool toonCursor = false);
    void setPercentage(double p);
    void setHoogte(int h);
    void setBreedte(int b);
    void genereer();
    void speelOplossingAf();
    void verwerkCursorActie();
};

// info blokje voor de gebruiker
void infoBlokje() {
    cout << "Door Koen van der Mije(s4809033) en Dylan Kusters (s4912926) " << endl
         << "Begonnen met de studie Informatica aan de Universiteit Leiden in september 2025. " << endl
         << "Opdracht 3 voor het vak Programmeermethoden. " << endl
         << "Deadline : 10 november. " << endl
         << "Deze code doet blabla" << endl; //TODO
}

// Maakt van een grote letter een kleine letter d.m.v. de ASCII tabel.
char maakKleineLetter(char a) {
    if (a >= 'A' && a <= 'Z') {
        return a + ('a' - 'A');
    } else { 
        return a;
    }
}

// Leest een karakter in die niet een spatie is
char optieInlezen() {
    char k = cin.get();
    while (k == '\n') { //als het een spatie is neem dan het volgende karakter
        k = cin.get();
    }
    cin.ignore(INT_MAX, '\n'); 
    return k;
}

// Leest een getal in (positief)
int leesGetal() {
    int getalbuffer = 0; //het getal wat is ingelezen
    bool heeftCijfer = false; //check of het een getal is of niet
    char k; //ingelezen karakter

    while (true) {
        if (!cin.get(k)) { //als er geen karakter is stopt de loop
            break;
        }
        if (k >= '0' && k <= '9') { //als het karakter een getal is wordt deze toegevoegd
            heeftCijfer = true;
            getalbuffer = (getalbuffer * 10) + (k - '0');
            if (getalbuffer > 9999) { //het getal wordt op 9999 gezet als deze groter is
                getalbuffer = 9999;
            }
        } else {
            if (heeftCijfer){
                break;
            } 
        }
    }
    return getalbuffer;
}

//Wisselt lamp naar aan of uit toestadn als het binnen de puzzel ligt.
void veranderSymbool(Puzzel& puzzel, int rij, int kolom){
    //Controleer of positie binnen de grenzen 
    if (rij >= 0 && rij < puzzel.hoogte && kolom >= 0 && kolom < puzzel.breedte) {
        int arrayRij = puzzel.hoogte - 1 - rij;  // Draai rij om (omdat index onderaan start)
        if (puzzel.dePuzzel[arrayRij][kolom] == 1) { //Wissel aan naar uit en uit naar aan
            puzzel.dePuzzel[arrayRij][kolom] = 0;
        } else {
            puzzel.dePuzzel[arrayRij][kolom] = 1;
        }
    }
}
//Schakelt een cel en zijn buren om 
void schakelCelOm(Puzzel& puzzel, int rij, int kolom) {
    veranderSymbool(puzzel, rij, kolom); // Schakelt cel om.
    //Posities van buurcellen
    int boven = rij - 1; 
    int onder = rij + 1;
    int links = kolom - 1;
    int rechts = kolom + 1;
    //Als torusmode aanstaat 
    if (puzzel.torusMode) {
         //verander posities van buurcellen als gekozen cel op de rand is
        if (boven < 0) { 
            boven = puzzel.hoogte - 1;}
        if (onder >= puzzel.hoogte) {
            onder = 0;}
        if (links < 0) {
            links = puzzel.breedte - 1;}
        if (rechts >= puzzel.breedte) {
            rechts = 0;}
     } 
    // Schakel naburige cellen om.
    veranderSymbool(puzzel, boven, kolom);  
    veranderSymbool(puzzel, onder, kolom);  
    veranderSymbool(puzzel, rij, links);    
    veranderSymbool(puzzel, rij, rechts);  
    }

//Eerste stap van puzzel oplossen, alleen onderste rij blijft over.
void volg(Puzzel& puzzel){
    // Van boven naar beneden door de puzzel (behalve onderste rij)
    for (int rij = puzzel.hoogte - 1; rij > 0; rij--) {   
        for (int kolom = 0; kolom < puzzel.breedte; kolom++) {
            int arrayRij = puzzel.hoogte - 1 - rij;  // Draai rij om (omdat index onderaan start)
            
            if (puzzel.dePuzzel[arrayRij][kolom] == 1){  // Als de lamp aan is
                schakelCelOm(puzzel, rij - 1, kolom);    // doe een zet op de cel eronder
                puzzel.drukaf(); //laat tussenstappen zien
            }
        }
    }
}
//Maakt een puzzel door random zetten te doen op een leeg veld.
void Puzzel::genereer() {
    maakschoon(); // Begin met leeg veld
    aantalZetten = 0; //reset het aantal zetten

    cout << "Voer een moeilijkheidsgraad in. (0-25 geeft de beste resultaten.)" << endl;
    int moeilijkheidsgraad = leesGetal();

    if (moeilijkheidsgraad > 100) {
        moeilijkheidsgraad = 100;}  //Max 100 zetten, omdat dit max is van aantalzetten array 
    //Doe een random zet gebaseerd op moeilijksgraad
    for (int a = 0; a < moeilijkheidsgraad; a++) { 
        int randomkolom = randomgetal() % breedte;
        int randomrij = randomgetal() % hoogte;
        schakelCelOm(*this, randomrij, randomkolom); 

        // Zetten opslaan die gebruikt zijn in het generen van de puzzel.
        oplossing[aantalZetten][0] = randomrij;
        oplossing[aantalZetten][1] = randomkolom;
        aantalZetten++;
    } 
    
}
//Gebruiker wordt gevraagd voor coordinaten om een zet te doen in de puzzel
void doeZet(Puzzel& puzzel ){
    puzzel.drukaf(); //Druk puzzel van tevoren af
    cout << "Kies een kolom (bv A of C): "; //Vraag gebruiker voor cel
            char letter = maakKleineLetter(optieInlezen());
            int kolom = (letter - 'a');           
            cout << "Kies een Rij  (bv 1 of 3): ";
            int rij = leesGetal();                
            int rijIndex = rij - 1; 
   

            if (rij <= 0 || rij > puzzel.hoogte || kolom < 0 || kolom >= puzzel.breedte) {
                cout << "Ongeldige invoer.\n"; //Als ingevoerde cel niet in puzzel zit
            } else {
                schakelCelOm(puzzel, rijIndex, kolom); 
            } //Doe een zet op de ingevoerde cel
            puzzel.drukaf(); //Druk puzzel na zet af
            }


void cursorMenu(Puzzel& puzzel) {
    char invoer;
    cout << "Gebruik W A S D om de cursor te bewegen en T om te stoppen.\n";

    puzzel.drukaf(true);  // eerste weergave met cursor

    while (true) {
        invoer = maakKleineLetter(optieInlezen());

        switch (invoer) {
        case 'w':
            if (puzzel.cursorRij < puzzel.hoogte - 1) puzzel.cursorRij++;
            break;
        case 's':
            if (puzzel.cursorRij > 0) puzzel.cursorRij--;
            break;
        case 'a':
            if (puzzel.cursorKolom > 0) puzzel.cursorKolom--;
            break;
        case 'd':
            if (puzzel.cursorKolom < puzzel.breedte - 1) puzzel.cursorKolom++;
            break;
        case 't':
            puzzel.drukaf(false); // laatste weergave zonder cursor
            return;
        }

        // Pas tegel aan volgens de huidige cursor-mode (lamp aan/uit of niets)
        puzzel.verwerkCursorActie();

        // Herteken met cursor
        puzzel.drukaf(true);
    }
}

//Gebruikt light chasing methode om een 5x5 puzzel op te lossen
void losOp(Puzzel& puzzel){
    volg(puzzel); //hierna is alleen onderste rij niet opgelost
    
    if (puzzel.torusMode){ //Kan niet oplossen met torus-mode
        cout << "Torus-mode staat aan, hierdoor kan de puzzel niet opgelost worden. \n";
        return;
    }

    int r = puzzel.hoogte - 1;//onderste rij 
    int k[5];  //kolommen waar een zet op moet
    int n = 0; //aantal kolommen
    //als onderste rij ook leeg is, dan is de puzzel al opgelost.
     if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==0 &&
        puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==0) {
        cout << "De puzzel is al opgelost!" << endl;
        return;
    }

    //Alle patronen van de onderste rij die opgelost kunnen worden
    // 0 = uit, 1 = aan
    if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==0 &&
    puzzel.dePuzzel[r][3]==1 && puzzel.dePuzzel[r][4]==1){ 
        k[0]=1; n=1; }

    else if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==1 &&
    puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==0){ 
            k[0]=2; n=1; }

    else if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==1 && puzzel.dePuzzel[r][2]==0 &&
    puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==1){ 
            k[0]=4; n=1; }

    else if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==1 && puzzel.dePuzzel[r][2]==1 &&
    puzzel.dePuzzel[r][3]==1 && puzzel.dePuzzel[r][4]==0){
        k[0]=0; k[1]=1; n=2; }

    else if (puzzel.dePuzzel[r][0]==1 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==0 &&
    puzzel.dePuzzel[r][3]==1 && puzzel.dePuzzel[r][4]==0){ 
        k[0]=0; n=1; }

    else if (puzzel.dePuzzel[r][0]==1 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==1 &&
    puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==1){ 
        k[0]=0; k[1]=3; n=2; }

    else if (puzzel.dePuzzel[r][0]==1 && puzzel.dePuzzel[r][1]==1 && puzzel.dePuzzel[r][2]==0 &&
        puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==0){
             k[0]=3; n=1; }
    
    else { //Als er een ander pattroon is, dan is de puzzel niet mogelijk met deze methode.
        cout << "De puzzel is niet mogelijk met de light chasing methode." << endl;
        return;
    }
    
    for (int i = 0; i < n; i++){ //Doe de bijbehorende zet (die bij het pattroon hoort)
        schakelCelOm(puzzel, 0, k[i]);
    }
    volg(puzzel); //Hierna zou puzzel opgelost moeten zijn.
}
//Speelt de oplossing af die in de genereer functie is opgeslagen
void Puzzel::speelOplossingAf() {
    if (aantalZetten == 0) { 
        cout << "Er zijn geen opgeslagen zetten om af te spelen.\n";
        return;//Als er geen zetten zijn opgeslagen wordt functie geskipt.
    }
    cout << "Oplossing wordt nu afgespeelt:\n";
    //speelt elke zet af en laat de tussenstappen zien 
    for (int i = 0; i < aantalZetten; i++) {
        int rij = oplossing[i][0];
        int kolom = oplossing[i][1];

        schakelCelOm(*this, rij, kolom);
        drukaf();
    }

    cout << "Oplossing is afgespeeld.\n";
}

// Tekensubmenu wordt geprint in de terminal waarbij de gebruiker alle keuzes in dit menu kan maken.
int tekensubmenu(Puzzel& puzzel) {
    char k;
    while (true) {
        cout << "Tekenmenu: Kies een optie: [T]erug, s[C]hoon, t[O]ggle, [R]andom of [G]enereer." << endl;
        k = optieInlezen();
        k = maakKleineLetter(k);
        switch (k) {
        case 'c': //Maakt puzzel leeg
            puzzel.maakschoon();
            break;
        case 'r': //Maakt random puzzel en druk deze af
            puzzel.maakrandom();
            puzzel.drukaf();
            break;
        case 'g': //Genereer mogelijke puzzel en druk deze af
            puzzel.genereer();
            puzzel.drukaf();
            break;
        case 'o': //Cursormenu: hiermee kan je de puzzel navigeren
        cursorMenu(puzzel);
            break;
        case 't': //Terug naar het hoofdmenu
            return 0;
        }
    }
}
// Puzzelsubmenu wordt geprint in de terminal waarbij de gebruiker alle keuzes in dit menu kan maken.
int puzzelmenu(Puzzel& puzzel){
    char k;
    while (true){
        cout << "Puzzelmenu: [T]erug, [V]olg, [L]os op, [A]fspelen, [D]oe zet.\n";
        k = maakKleineLetter(optieInlezen());
        switch(k){
            case 't': //Terug naar hoofdmenu
            return 0;
            case 'v': //Lost de puzzel op, maar niet de eerste rij
            volg(puzzel);
            break;
            case 'l': //Lost de puzzel op
            losOp(puzzel);
            break;
            case 'a':  //Speel oplossing af die in genereer() is opgeslagen
            puzzel.speelOplossingAf();
            break;
            case 'd': 
            doeZet(puzzel);
            break;
        }
    }
}

// Parametersubmenu wordt geprint in de terminal waarbij de gebruiker alle keuzes in dit menu kan maken.
int parametermenu(Puzzel& puzzel){
    char k; 
    while (true){
        cout << "Parametermenu: [T]erug, [H]oogte, [B]reedte, [P]ercentage, [K]arakters, [D]oorloop, [C]ursor.\n";
        k = maakKleineLetter(optieInlezen());
        switch(k){
            case 't': //Terug naar hoofdmenu 
            return 0;

            case 'h': { //Gebruiker kan nieuwe hoogte van de puzzel kiezen
                cout << "Nieuwe hoogte: ";
                puzzel.setHoogte(leesGetal());
                break;
            }
            case 'b': { //Gebruiker kan nieuwe breedte van de puzzel kiezen
                cout << "Nieuwe breedte: ";
                puzzel.setBreedte(leesGetal());
                break;
            }
            case 'p': { //Gebruiker kan percentage van de lampen die aan staan in een random puzzel kiezen
                cout << "Percentage lampen: ";
                puzzel.setPercentage(leesGetal());
                break;
            }
            case 'k': //Gebruiker kan nieuwe symbolen kiezen voor lampen die aan of uit staan
                cout << "Symbool aan: ";
                puzzel.symboolLampAan = optieInlezen();
                cout << "Symbool uit: ";
                puzzel.symboolLampUit = optieInlezen();
                break;

            case 'd': { //Gebruiker kan torus mode aan zetten.
                cout << "Torus aan? (j/n) ";
                char t = maakKleineLetter(optieInlezen());
                if (t =='j') {
                    puzzel.torusMode = true;
                    cout << "Torus-mode staat nu aan!" << endl;}
                else{
                    cout << "Torus-mode staat niet aan." << endl;}
                break;
            }
            case 'c': { //Gebruiker kan cursor mode veranderen.
                cout << "Cursor-mode (0/1/2): ";
                int mod = leesGetal();
                if (mod == 1) puzzel.cursorSymbool = puzzel.symboolLampAan;
                else if (mod == 2) puzzel.cursorSymbool = puzzel.symboolLampUit;
                else puzzel.cursorSymbool = ' ';
                break;
            }
        }
    }
}

// Menu wordt geprint in de terminal waarbij de gebruiker keuzes in dit menu kan maken.
int menu(Puzzel& puzzel) {
    char keuze;
    while (true) {
        cout << "Kies een optie: [P]arameters, p[U]zzelmenu, [T]ekenen of [S]toppen." << endl;
        keuze = optieInlezen();
        keuze = maakKleineLetter(keuze);
        switch (keuze) { 
        case 's': //Stopt het programma
            return 1;
        case 'p': //Parametersubmenu opent
            while (parametermenu(puzzel) != 0);
            break;
        case 'u': //Puzzelsubmenu opent
            while (puzzelmenu(puzzel) != 0);
            break;
        case 't': //Tekensubmenu opent
            while (tekensubmenu(puzzel) != 0);
            break;
        }
    }
}

//Constructor
Puzzel::Puzzel(int h, int b, double p, char a, char u, char c, bool t, int r, int k)
    : hoogte(h), breedte(b), percentage(p), symboolLampAan(a),
      symboolLampUit(u), cursorSymbool(c), torusMode(t), cursorRij(r), cursorKolom(k) {
    randomNum = randomgetal();
    maakschoon(); 
}
//Kiest een random getal 0-9
int Puzzel::randomgetal() {
    static int getal = 42;       
    getal = (221 * getal + 1) % 1000;
    return getal;
}
//Maakt de puzzel leeg
void Puzzel::maakschoon() {
    aantalZetten = 0; 
    for (int i = 0; i < MaxGrootte; ++i) {
        for (int j = 0; j < MaxGrootte; ++j) {
            dePuzzel[i][j] = 0; //voor elke cel, maak cel 0
        }
    }
    cout << "Puzzel is leeggemaakt.\n";
}

//
void Puzzel::verwerkCursorActie() {
    if (cursorSymbool == symboolLampAan) {
        dePuzzel[hoogte - 1 - cursorRij][cursorKolom] = true;
    } 
    else if (cursorSymbool == symboolLampUit) {
        dePuzzel[hoogte - 1 - cursorRij][cursorKolom] = false;
    }
}

// Print de puzzel
void Puzzel::drukaf(bool toonCursor) {
    for (int i = 0; i < hoogte; ++i) {
        for (int j = 0; j < breedte; ++j) {
            int visueelRij = hoogte - 1 - i;

            // Toon cursor alleen als toonCursor == true
            if (toonCursor && visueelRij == cursorRij && j == cursorKolom)
                cout << "* ";
            else
                cout << (dePuzzel[i][j] ? symboolLampAan : symboolLampUit) << " ";
        }
        cout << endl;
    }
}

// Maak een willekeurige puzzel
void Puzzel::maakrandom() {
    for (int i = 0; i < hoogte; ++i) {
        for (int j = 0; j < breedte; ++j) {
            int getal = randomgetal() % 100;
            dePuzzel[i][j] = (getal < percentage) ? 1 : 0;
        }
    }
    cout << "Willekeurige puzzel gegenereerd.\n";
}

// Stel hoogte in
void Puzzel::setHoogte(int h) {
    if (h > 0 && h <= MaxGrootte) {
        hoogte = h;
    } else {
        hoogte = 5;
    }
}

// Stel breedte in
void Puzzel::setBreedte(int b) {
    if (b > 0 && b <= MaxGrootte) {
        breedte = b;
    } else {
        breedte = 5;
    }
}

// Stel percentage in
void Puzzel::setPercentage(double p) {
    if (p >= 0 && p <= 100) {
        percentage = p;
    } else {
        percentage = 50;
    }
}

int main() {
    infoBlokje();
    Puzzel mijnPuzzel;
    mijnPuzzel.maakrandom();
    mijnPuzzel.drukaf();
    menu(mijnPuzzel);
    return 0;
}
