// Deze code is gemaakt door Koen van der Mije(s4809033) en Dylan Kusters (s4912926).
//Opdracht 3 van programmeermethoden: Lights out.

#include <iostream>
#include <fstream>
#include <climits>


using namespace std;

class Puzzel {
public:
    static const int MaxGrootte = 20; //max hoogte van de puzzel
    

    int hoogte;
    int breedte;
    double percentage;
    char symboolLampAan;
    char symboolLampUit;
    char cursorSymbool;
    bool torusModus;
    int randomNum;
    int cursorKolom;
    int cursorRij;
    int dePuzzel[MaxGrootte][MaxGrootte];
    int oplossing[100][2];
    int aantalZetten;

    Puzzel(int h = 5, int b = 5, double p = 50.0, char a = 'X', char u = '.', char c = ' ', bool t = false, int k = 1, int r = 1);
    int randomgetal();
    void maakschoon();
    void maakrandom();
    void drukaf();
    void setPercentage(double p);
    void setHoogte(int h);
    void setBreedte(int b);
    void genereer();
    void speelOplossingAf();
};

// INFO BLOKJE
void infoBlokje() {
    cout << "Door Koen van der Mije(s4809033) en Dylan Kusters (s4912926) " << endl
         << "Begonnen met de studie Informatica aan de Universiteit Leiden in september 2025. " << endl
         << "Opdracht 3 voor het vak Programmeermethoden. " << endl
         << "Deadline : 10 november. " << endl
         << "Deze code doet blabla" << endl;
}

// Maakt een grote letter een kleine letter.
char maakKleineLetter(char a) {
    if (a >= 'A' && a <= 'Z') {
        return a + ('a' - 'A');
    } else {
        return a;
    }
}

// Leest een karakter in
char optieInlezen() {
    char k = cin.get();
    while (k == '\n') {
        k = cin.get();
    }
    cin.ignore(INT_MAX, '\n');
    return k;
}

// Leest een getal in (positief)
int leesGetal() {
    int getalbuffer = 0;
    bool heeftCijfer = false;
    char k;

    while (true) {
        if (!cin.get(k)) {
            break;
        }
        if (k >= '0' && k <= '9') {
            heeftCijfer = true;
            getalbuffer = (getalbuffer * 10) + (k - '0');
            if (getalbuffer > 9999) {
                getalbuffer = 9999;
            }
        } else {
            if (heeftCijfer) break;
        }
    }
    return getalbuffer;
}

//Maakt lamp aan of uit als het binnen de puzzel ligt.
void veranderSymbool(Puzzel& puzzel, int rij, int kolom){
    if (rij >= 0 && rij < puzzel.hoogte && kolom >= 0 && kolom < puzzel.breedte) {
        int arrayRij = puzzel.hoogte - 1 - rij;  // Draai rij om
        puzzel.dePuzzel[arrayRij][kolom] = (puzzel.dePuzzel[arrayRij][kolom] == 1 ? 0 : 1);
    }
}

void schakelCelOm(Puzzel& puzzel, int rij, int kolom) {
    veranderSymbool(puzzel, rij, kolom);
    
    int boven = rij - 1;
    int onder = rij + 1;
    int links = kolom - 1;
    int rechts = kolom + 1;
    
    if (puzzel.torusModus) {
        if (boven < 0) boven = puzzel.hoogte - 1;
        if (onder >= puzzel.hoogte) onder = 0;
        if (links < 0) links = puzzel.breedte - 1;
        if (rechts >= puzzel.breedte) rechts = 0;
        
        // Schakel alle naburige cellen om (in torus modus altijd geldig)
        veranderSymbool(puzzel, boven, kolom);
        veranderSymbool(puzzel, onder, kolom);
        veranderSymbool(puzzel, rij, links);
        veranderSymbool(puzzel, rij, rechts);
    } else {
        // Zonder torus modus: alleen omschakelen als in puzzel
        veranderSymbool(puzzel, boven, kolom);  
        veranderSymbool(puzzel, onder, kolom);  
        veranderSymbool(puzzel, rij, links);    
        veranderSymbool(puzzel, rij, rechts);  
    }
}

void volg(Puzzel& puzzel){
    // Van boven naar beneden door de visuele puzzel (behalve onderste rij)
    for (int rij = puzzel.hoogte - 1; rij > 0; rij--) {   
        for (int kolom = 0; kolom < puzzel.breedte; kolom++) {
            int arrayRij = puzzel.hoogte - 1 - rij;  // Converteer visuele rij naar array index
            
            if (puzzel.dePuzzel[arrayRij][kolom] == 1){  // lamp aan?
                schakelCelOm(puzzel, rij - 1, kolom);    // zet op cel ERONDER (rij - 1 in visuele coÃ¶rdinaten)
                puzzel.drukaf();
            }
        }
    }
}

void Puzzel::genereer() {
    maakschoon();
    aantalZetten = 0;

    cout << "Voer een moeilijkheidsgraad in. (0-25 geeft de beste resultaten.)" << endl;
    int moeilijkheidsgraad = leesGetal();

    if (moeilijkheidsgraad > 100) moeilijkheidsgraad = 100;

    for (int a = 0; a < moeilijkheidsgraad; a++) {
        int randomkolom = randomgetal() % breedte;
        int randomrij = randomgetal() % hoogte;
        //*this verwijst naar de huidige puzzel
        schakelCelOm(*this, randomrij, randomkolom); 

        // Zetten opslaan
        oplossing[aantalZetten][0] = randomrij;
        oplossing[aantalZetten][1] = randomkolom;
        aantalZetten++;
    } 
    
}

void cursorMenu(Puzzel& puzzel) {
    cout << "Gebruik W A S D om de cursor te bewegen en T om te stoppen.\n";
    
    char invoer;
    puzzel.drukaf();
    while (true) {
        invoer = maakKleineLetter(optieInlezen());
        switch (invoer) {
        case 'w':
            if (puzzel.cursorRij < puzzel.hoogte - 1) puzzel.cursorRij++;
            break;
        case 's':
            if (puzzel.cursorRij > 0) puzzel.cursorRij--;
            break;
        case 'a':
            if (puzzel.cursorKolom > 0) puzzel.cursorKolom--;
            break;
        case 'd':
            if (puzzel.cursorKolom < puzzel.breedte - 1) puzzel.cursorKolom++;
            break;
        case 't':
            return;
        }
        puzzel.drukaf();
    }
}

void schakelMeerdereCellen(Puzzel& puzzel, int coords[][2], int aantal) {
    for (int i = 0; i < aantal; i++) {
        int rij = coords[i][0];
        int kolom = coords[i][1];
        schakelCelOm(puzzel, rij, kolom);
    }
}


void losOp(Puzzel& puzzel){
    volg(puzzel); //hierna is alleen onderste rij niet opgelost
    
    if (puzzel.torusModus){
        cout << "Torus-modus staat aan, hierdoor kan de puzzel niet opgelost worden. \n";
        return;
    }

    int r = puzzel.hoogte - 1;//onderste rij 
    int k[5];  //kolommen waar een zet op moet
    int n = 0; //aantal kolommen
    
     if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==0 &&
        puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==0) {
        cout << "De puzzel is al opgelost!" << endl;
        return;
    }

    //Alle patronen van de onderste rij die opgelost kunnen worden
    // 0 = uit, 1 = aan
    if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==0 &&
    puzzel.dePuzzel[r][3]==1 && puzzel.dePuzzel[r][4]==1){ 
        k[0]=1; n=1; }

    else if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==1 &&
    puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==0){ 
            k[0]=2; n=1; }

    else if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==1 && puzzel.dePuzzel[r][2]==0 &&
    puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==1){ 
            k[0]=4; n=1; }

    else if (puzzel.dePuzzel[r][0]==0 && puzzel.dePuzzel[r][1]==1 && puzzel.dePuzzel[r][2]==1 &&
    puzzel.dePuzzel[r][3]==1 && puzzel.dePuzzel[r][4]==0){
        k[0]=0; k[1]=1; n=2; }

    else if (puzzel.dePuzzel[r][0]==1 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==0 &&
    puzzel.dePuzzel[r][3]==1 && puzzel.dePuzzel[r][4]==0){ 
        k[0]=0; n=1; }

    else if (puzzel.dePuzzel[r][0]==1 && puzzel.dePuzzel[r][1]==0 && puzzel.dePuzzel[r][2]==1 &&
    puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==1){ 
        k[0]=0; k[1]=3; n=2; }

    else if (puzzel.dePuzzel[r][0]==1 && puzzel.dePuzzel[r][1]==1 && puzzel.dePuzzel[r][2]==0 &&
        puzzel.dePuzzel[r][3]==0 && puzzel.dePuzzel[r][4]==0){
             k[0]=3; n=1; }
    
    else {
        cout << "De puzzel is niet mogelijk met de light chasing methode." << endl;
        return;
    }
    
    for (int i = 0; i < n; i++){
        schakelCelOm(puzzel, 0, k[i]);
    }
    volg(puzzel);
}
        
void Puzzel::speelOplossingAf() {
    if (aantalZetten == 0) {
        cout << "Er zijn geen opgeslagen zetten om af te spelen.\n";
        return;
    }

    cout << "Oplossing afspelen:\n";

    for (int i = 0; i < aantalZetten; i++) {
        int rij = oplossing[i][0];
        int kolom = oplossing[i][1];

        schakelCelOm(*this, rij, kolom);
        drukaf();


    }

    cout << "Oplossing is toegepast.\n";
}

// TEKEN SUBMENU
int tekensubmenu(Puzzel& puzzel) {
    char k;
    while (true) {
        cout << "Tekenmenu: Kies een optie: [T]erug, s[C]hoon, t[O]ggle, [R]andom of [G]enereer." << endl;
        k = optieInlezen();
        k = maakKleineLetter(k);
        switch (k) {
        case 'c':
            puzzel.maakschoon();
            break;
        case 'r':
            puzzel.maakrandom();
            break;
        case 'g':
            puzzel.genereer();
            puzzel.drukaf();
            break;
        case 'o':
        cursorMenu(puzzel);
            break;
        case 't':
            return 0;
        }
    }
}
//Puzzelmenu
int puzzelmenu(Puzzel& puzzel){
    char k;
    while (true){
        cout << "Puzzelmenu: [T]erug, [V]olg, [L]os op, [A]fspelen, [D]oe zet.\n";
        k = maakKleineLetter(optieInlezen());
        switch(k){
            case 't':
            return 0;
            case 'v':
            volg(puzzel);
            break;
            case 'l':
            losOp(puzzel);
            break;
            case 'a': 
            puzzel.speelOplossingAf();
            break;
            case 'd': //Dit zou nog in een (member)functie kunnen
            cout << "Kies een de kolom (bv A of C): ";
            char letter = maakKleineLetter(optieInlezen());
            int kolom = (letter - 'a');           
            cout << "Kies een de Rij  (bv 1 of 3): ";
            int rij = leesGetal();                
            int rijIndex = rij - 1; 
   

            if (rij <= 0 || rij > puzzel.hoogte || kolom < 0 || kolom >= puzzel.breedte) {
                cout << "Ongeldige invoer.\n";
            } else {
                schakelCelOm(puzzel, rijIndex, kolom);
            }
            puzzel.drukaf();
            break;}
        }
    }


// PARAMETERMENU
int parametermenu(Puzzel& puzzel){
    char k; 
    while (true){
        cout << "Parametermenu: [T]erug, [H]oogte, [B]reedte, [P]ercentage, [K]arakters, [D]oorloop, [C]ursor.\n";
        k = maakKleineLetter(optieInlezen());
        switch(k){
            case 't': return 0;

            case 'h': {
                cout << "Nieuwe hoogte: ";
                puzzel.setHoogte(leesGetal());
                break;
            }
            case 'b': {
                cout << "Nieuwe breedte: ";
                puzzel.setBreedte(leesGetal());
                break;
            }
            case 'p': {
                cout << "Percentage lampen: ";
                puzzel.setPercentage(leesGetal());
                break;
            }
            case 'k':
                cout << "Symbool aan: ";
                puzzel.symboolLampAan = optieInlezen();
                cout << "Symbool uit: ";
                puzzel.symboolLampUit = optieInlezen();
                break;

            case 'd': {
                cout << "Torus aan? (j/n) ";
                char t = maakKleineLetter(optieInlezen());
                if (t =='j') {
                    puzzel.torusModus = true;
                    cout << "Torus-modus staat nu aan!" << endl;}
                else{
                    cout << "Torus-modus staat niet aan." << endl;}
                break;
            }
            case 'c': {
                cout << "Cursor-modus (0/1/2): ";
                int mod = leesGetal();
                if (mod == 1) puzzel.cursorSymbool = puzzel.symboolLampAan;
                else if (mod == 2) puzzel.cursorSymbool = puzzel.symboolLampUit;
                else puzzel.cursorSymbool = ' ';
                break;
            }
        }
    }
}

// HOOFDMENU
int menu(Puzzel& puzzel) {
    char keuze;
    while (true) {
        cout << "Kies een optie: [P]arameters, p[U]zzelmenu, [T]ekenen of [S]toppen." << endl;
        keuze = optieInlezen();
        keuze = maakKleineLetter(keuze);
        switch (keuze) {
        case 's':
            return 1;
        case 'p':
            while (parametermenu(puzzel) != 0);
            break;
        case 'u':
            while (puzzelmenu(puzzel) != 0);
            break;
        case 't':
            while (tekensubmenu(puzzel) != 0);
            break;
        }
    }
}

//Constructor
Puzzel::Puzzel(int h, int b, double p, char a, char u, char c, bool t, int r, int k)
    : hoogte(h), breedte(b), percentage(p), symboolLampAan(a),
      symboolLampUit(u), cursorSymbool(c), torusModus(t), cursorRij(r), cursorKolom(k) {
    randomNum = randomgetal();
    maakschoon(); 
}
//Kiest een random getal 0-9
int Puzzel::randomgetal() {
    static int getal = 42;       
    getal = (221 * getal + 1) % 1000;
    return getal;
}
//Maakt de puzzel leeg
void Puzzel::maakschoon() {
    aantalZetten = 0; 
    for (int i = 0; i < MaxGrootte; ++i) {
        for (int j = 0; j < MaxGrootte; ++j) {
            dePuzzel[i][j] = 0;
        }
    }
    cout << "Puzzel is leeggemaakt.\n";
}

// Print de puzzel
void Puzzel::drukaf() {
    cout << "Puzzel (" << hoogte << "x" << breedte << ", " << percentage << "% aan):\n";
    for (int i = 0; i < hoogte; ++i) {
        for (int j = 0; j < breedte; ++j) {
            int visueelRij = hoogte - 1 - i;
            if (visueelRij == cursorRij && j == cursorKolom) {
                cout << "[" << (dePuzzel[i][j] ? symboolLampAan : symboolLampUit) << "]";
            } else {
                cout << (dePuzzel[i][j] ? symboolLampAan : symboolLampUit) << " ";
            }
        }
        cout << endl;
    }
}

// Maak een willekeurige puzzel
void Puzzel::maakrandom() {
    for (int i = 0; i < hoogte; ++i) {
        for (int j = 0; j < breedte; ++j) {
            int getal = randomgetal() % 100;
            dePuzzel[i][j] = (getal < percentage) ? 1 : 0;
        }
    }
    cout << "Willekeurige puzzel gegenereerd.\n";
}

// Stel hoogte in
void Puzzel::setHoogte(int h) {
    hoogte = (h > 0 && h <= MaxGrootte) ? h : 5;
}

// Stel breedte in
void Puzzel::setBreedte(int b) {
    breedte = (b > 0 && b <= MaxGrootte) ? b : 5;
}

// Stel percentage in
void Puzzel::setPercentage(double p) {
    percentage = (p >= 0 && p <= 100) ? p : 50;
}
int main() {
    infoBlokje();
    Puzzel mijnPuzzel;
    mijnPuzzel.maakrandom();
    mijnPuzzel.drukaf();
    menu(mijnPuzzel);
    return 0;
}
